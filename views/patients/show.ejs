<% include ../partials/header %>


    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/patients">Ασθενεις</a></li>
        </ol>
    </nav>



    <div class="container-fluid">
        <div class="row">
            <div class="col-3">
                <div class="text-center">
                    <h1>Στοιχεία Ασθενή</h1>
                </div>
                <div class="card text-center mx-auto">
                    <img src="https://eitrawmaterials.eu/wp-content/uploads/2016/09/person-icon.png" class="card-img-top">
                    <div class="card-body">
                        <div class="row patient_row">
                            <div class="col-sm">Όνομα :</div>
                            <div class="col-sm">
                                <%= patient.firstName %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Επώνυμο :</div>
                            <div class="col-sm">
                                <%= patient.lastName %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Πατρώνυμο:</div>
                            <div class="col-sm">
                                <%= patient.patronym %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Ηλικία :</div>
                            <div class="col-sm">
                                <%= moment(patient.birthday).format('DD-MM-YYYY') %>
                            </div>

                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">AM :</div>
                            <div class="col-sm">
                                <%= patient.patientAM %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Bάρος :</div>
                            <div class="col-sm">
                                <%= patient.weight %> kg
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Ύψος :</div>
                            <div class="col-sm">
                                <%= patient.height %> m
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Κινητό Τηλέφωνο :</div>
                            <div class="col-sm">
                                <%= patient.mPhone %>
                            </div>
                        </div>

                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Πόλη/Χωριό :</div>
                            <div class="col-sm">
                                <%= patient.city %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Διεύθυνση :</div>
                            <div class="col-sm">
                                <%= patient.address %>
                            </div>
                        </div>
                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Τύπος Αίματος :</div>
                            <div class="col-sm">
                                <%= patient.bloodType %>
                            </div>
                        </div>

                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Γιατρός :</div>
                            <div class="col-sm">
                                <%= patient.doc %>
                            </div>
                        </div>



                        <div class="row mt-3 patient_row">
                            <div class="col-sm">Γενικές Πληροφορίες :</div>
                            <div class="col-sm">
                                <%= patient.general %>
                            </div>
                        </div>

                        <div class="row mt-3 patient_row">
                            <div class="col-sm">
                                <span class="pull-right">
                                    <p>
                                        Δημιουργήθηκε απο τον/την : <%= patient.author.username %>, <%=
                                                moment(patient.createdAt).fromNow() %>
                                    </p>
                                </span>
                            </div>
                        </div>



                        <% if(currentUser && patient.author.id.equals(currentUser._id) || currentUser &&
                            currentUser.isAdmin){ %>
                            <div class="row mt-3">
                                <p class="col-sm">
                                    <a class="btn btn-warning btn-larg" href="/patients/<%= patient._id %>/edit">Επεξεργασία</a>
                                </p>
                            </div>

                            <div data-toggle="tooltip" data-placement="right" title="Για να διαγραψετε αυτη την εγγραφη , πρεπει πρωτα να διαγραφουν ολες οι ανοσοθεραπειες της.">
                                <form id="delete-form" action="/patients/<%= patient._id %>?_method=DELETE" method="POST">
                                    <button id='disableBtnPatient' class="btn btn-xs btn-danger">Διαγραφή</button>
                                </form>
                            </div>

                            <% } %>
                    </div>
                </div>
            </div>
            <div class="col-7">

                <div>
                    <h1 class="text-center ">Ανοσοθεραπείες <button style="display:none" type="button" class="btn btn-primary">Expand/Collapse All</button></h1>
                </div>




                <div class="accordion" id="accordionExample">
                    <div class="card">
                        <% data.patient.diagnoses.forEach(function(x, index){ %>
                            <% var tIndex="heading_" +index %>
                                <% var zIndex="collapse_" +index %>
                                    <div class="card-header" id="<%=tIndex%>">
                                        <h2 class="mb-0">
                                            <button class="btn btn-block text-left btn-success" type="button" data-toggle="collapse" data-target="#<%=zIndex%>" aria-expanded="true" aria-controls="<%=zIndex%>">
                                                <a class="link-success font-weight-bold text-white"
                                                    href="/patients/<%= patient._id %>/diagnoses/<%= x._id %>">ΑΝΟΣΟΘΕΡΑΠΕΙΑ
                                                    <%= moment(x.date).format('DD-MM-YYYY') %> -
                                                        <%= x.courseOfTreatment %> -
                                                            <%= x.doc %> </a>
                                                            <span class="badge badge-light float-right"><%=
                                                              x.treatments.length %> Δοσεις <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-circle-fill" viewBox="0 0 16 16">
                                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
                                                              </svg></span>
                                                
                                                </button>
                                            <button class="btn btn-primary">
                                                    <a class = 'text-white' href="/patients/<%= patient._id %>/diagnoses/<%= x._id %>/treatments/new">Δημιουργία Δοσης</a>
                                                </button>
                                            <% if(currentUser && patient.author.id.equals(currentUser._id) ||
                                                currentUser && currentUser.isAdmin){ %>
                                                <div class="btn-group" role="group" aria-label="Basic example">
                                                    <form action="" class='mr-2'>
                                                        <button name="button" class="btn btn-warning"> <a
                                                                href="/patients/<%= patient._id %>/diagnoses/<%= x._id %>/edit">Επεξεργασία </a></button>
                                                    </form>

                                                    <!-- <form id="delete-form" action="/patients/<%= patient._id %>/diagnoses/<%= x._id %>?_method=DELETE" method="POST">
                                                        <button class="btn btn-danger checkDeletion">Διαγραφή</button>
                                                    </form> -->

                                                    <%if(Object.keys(x.treatments).length === 0){%>

                                                        <form id="delete-form" action="/patients/<%= patient._id %>/diagnoses/<%= x._id %>?_method=DELETE" method="POST">
                                                            <button class="btn btn-danger ">Διαγραφή</button>
                                                        </form>
                                                        <%} else {%>
                                                            <div data-toggle="tooltip" data-placement="right" title="Για να διαγραψετε αυτη την εγγραφη , πρεπει πρωτα να διαγραφουν ολες οι Δοσεις της.">
                                                                <form id="delete-form" action="/patients/<%= patient._id %>/diagnoses/<%= x._id %>?_method=DELETE" method="POST">
                                                                    <button class="btn btn-danger" disabled>Διαγραφή</button>
                                                                </form>
                                                            </div>
                                                            <%}%>
                                                </div>
                                                <% } %>
                                        </h2>
                                    </div>

                                    <div id="<%=zIndex%>" class="collapse" aria-labelledby="<%=tIndex%>_dose">


                                        <% data.treatment.forEach(function(y, index){ %>
                                            <%if (x.treatments.includes(y._id)){%>

                                                <div class="card-body">


                                                    <% var tIndex="heading1_" +index %>
                                                        <% var zIndex="collapse1_" +index %>
                                                            <div class="card-header" id="<%=tIndex%>_dose">
                                                                <h2 class="mb-0">
                                                                    <button class="btn btn-block text-left btn-success" type="button" data-toggle="collapse" data-target="#<%=zIndex%>_dose" aria-expanded="true" aria-controls="<%=zIndex%>">
                                                                        <a class='font-weight-bold text-white'
                                                                            href="/patients/<%= patient._id %>/diagnoses/<%= x.id %>/treatments/<%=y._id %>">ΔΟΣΗ
                                                                            <%= moment(y.date).format('DD-MM-YYYY') %>
                                                                                -%>
                                                                                <%= y.status %> -%>
                                                                                    <%= y.staff %> -%>
                                                                                        <%= y.numOfApproval %> - %>
                                                                                            <%= y.numOfDose %> %></a>
                                                                        <span
                                                                            class="badge badge-light float-right"><%= y.effects.length%>  Παρενεργειες <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down-circle-fill" viewBox="0 0 16 16">
                                                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V4.5z"/>
                                                                              </svg>
                                                                        </span>
                                                                    </button>

                                                                    <% if(currentUser &&
                                                                        patient.author.id.equals(currentUser._id) ||
                                                                        currentUser && currentUser.isAdmin){ %>
                                                                        <div class="btn-group" role="group" aria-label="Basic example">
                                                                            <form action="" class='mr-2'>
                                                                                <button name="button" class="btn btn-warning"> <a
                                                                                        href="/patients/<%= patient._id %>/diagnoses/<%= x.id %>/treatments/<%=y._id %>/edit">Επεξεργασία</a></button>
                                                                            </form>
                                                                            <% if(Object.keys(y.effects).length === 0 ){%>
                                                                                <form id="delete-form" action="/patients/<%= patient._id %>/diagnoses/<%= x.id %>/treatments/<%=y._id %>?_method=DELETE" method="POST">
                                                                                    <button class="btn btn-danger">Διαγραφή</button>
                                                                                </form>
                                                                                <% }else{%>
                                                                                    <div data-toggle="tooltip" data-placement="right" title="Για να διαγραψετε αυτη την εγγραφη , πρεπει πρωτα να διαγραφουν ολες οι παρενέργειες της.">
                                                                                        <form id="delete-form" action="/patients/<%= patient._id %>/diagnoses/<%= x.id %>/treatments/<%=y._id %>?_method=DELETE" method="POST">
                                                                                            <button class="btn btn-danger" disabled>Διαγραφή</button>
                                                                                        </form>
                                                                                    </div>
                                                                                    <%}%>

                                                                        </div>
                                                                        <% } %>
                                                                </h2>
                                                            </div>

                                                </div>
                                                <% }%>
                                                    <div id="<%=zIndex%>_dose" class="collapse" aria-labelledby="<%=tIndex%>_dose">

                                                        <div class="card-body">

                                                            <% if(y.effects.length ===0){%>

                                                                <div class="badge badge-primary text-wrap" style="width: 6rem;">
                                                                    Δεν υπαρχουν παρενεργειες
                                                                </div>

                                                                <%}%>
                                                                    <% y.effects.forEach(function(ef, index){ %>

                                                                        <%arr=[]%>

                                                                            <%['pancreas', 'eyesight' , 'muscle' , 'skin' , 'lungs'
                                                                , 'stomach_bowel' ].forEach(function(des){%>
                                                                                <% dat=ef[des].effects %>

                                                                                    <% for (let [skey, svalue] of Object.entries(dat)) {
                                                                        %>
                                                                                        <% if(svalue && skey!=='$init' ){ %>


                                                                                            <% for (let [keyy, valuee] of
                                                                                Object.entries(effects)) { %>

                                                                                                <% for (let [keyy1, valuee1] of
                                                                                    Object.entries(valuee.effects)) { %>

                                                                                                    <%if (keyy1===skey){%>
                                                                                                        <% arr.push(valuee1.name)%>
                                                                                                            <%}%>
                                                                                                                <%}%>
                                                                                                                    <%}%>


                                                                                                                        <% } %>
                                                                                                                            <%}%>
                                                                                                                                <%})%>

                                                                                                                                    <div class='card-group'>
                                                                                                                                        <div class="card bg-info">
                                                                                                                                            <div class="card-body">
                                                                                                                                                <h4 class="card-title">
                                                                                                                                                    <%= moment(ef.date).format('DD-MM-YYYY')
                                                                                                                                        %>
                                                                                                                                                </h4>
                                                                                                                                                <p class="card-text font-weight-bold">

                                                                                                                                                    <%= arr.join(',')
                                                                                                                                        %>
                                                                                                                                                </p>
                                                                                                                                                <div class="btn-group" role="group" aria-label="Basic example">
                                                                                                                                                    <form action="" class='mr-2'>
                                                                                                                                                        <button name="button" class="btn btn-warning">
                                                                                                                                            <a
                                                                                                                                                href="/effects/<%= ef._id %>/edit">Επεξεργασία</a></button>
                                                                                                                                                    </form>
                                                                                                                                                    <form id="delete-form" action="/effects/delete/<%= ef._id %>?_method=DELETE" method="POST">
                                                                                                                                                        <button class="btn btn-danger">Διαγραφή</button>
                                                                                                                                                    </form>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                        </div>

                                                                                                                                    </div>






                                                                                                                                    <% })%>

                                                        </div>
                                                        <div class="container-fluid">
                                                            <div class='effectsForm'>
                                                                <form class='formEffects'>


                                                                    <div class="row">
                                                                        <% for (const [key, value] of Object.entries(effects)) { %>

                                                                            <div class="col-sm mt-2">
                                                                                <ul class="list-group docs">

                                                                                    <li class="list-group-item active">
                                                                                        <%= value.baseName %>
                                                                                    </li>
                                                                                    <% for (const [key1, value1] of Object.entries(value.effects)) { %>

                                                                                        <li class="list-group-item ">
                                                                                            <input type="checkbox" id='<%= key1 %>' name='<%= key1 %>' class="btn-check checkers" !checked />
                                                                                            <%= value1.name %>
                                                                                                <!-- <input type="checkbox" class="btn-check" id='<%= key1 %>' name='<%= key1 %>' !checked autocomplete="off">
                                                                                            <label class="btn btn-primary" for='<%= key1 %>'><%= value1.name %></label> -->
                                                                                                <!-- <br> -->

                                                                                        </li>
                                                                                        <% } %>

                                                                                </ul>
                                                                            </div>

                                                                            <% } %>

                                                                                <div class="form-group row">
                                                                                    <label class="col-sm col-form-label" for="colFormLabel">Ημερομηνία :</label>
                                                                                    <div class="col-sm-10">
                                                                                        <input type="date" class="form-control <%=y.id%>Date " id="colFormLabel" name="datep" placeholder="Ημερομηνία">
                                                                                    </div>
                                                                                </div>

                                                                                <!-- <p>Date: <input type="text" id="datepicker" class='effectdate'></p>  2nd way with datepicker-->
                                                                                <div class="col-sm-10">
                                                                                    <button data-id='<%=y.id%>' type="submit" class="addbtn1 btn btn-primary mb-4 ">Αποθηκευση</button>
                                                                                </div>
                                                                    </div>

                                                                </form>
                                                            </div>




                                                        </div>

                                                        <button type="submit" class="btn btn-info showForm">Προσθηκη φορμας παρενεργειων</button>
                                                    </div>


                                                    <% }) %>
                                    </div>
                                    <% }) %>

                    </div>

                </div>


                <button class="btn btn-primary">
                    <a class='text-white' href="/patients/<%= patient._id %>/diagnoses/new">Δημιουργία
                        Ανοσοθεραπείας</a>
                    </button>

            </div>

            <div class="col-2">




                <div>
                    <h1 class="text-center ">Αρχεία</h1>
                </div>
                <form action="/patients/<%= patient._id %>" method="POST" enctype="multipart/form-data">
                    <!--?_method=PUT -->
                    <div class="form-group ">
                        <label for="exampleFormControlFile1">File input</label>
                        <input name="myImage" type="file" class="form-control-file" id="exampleFormControlFile1">
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
                <div class="list-group mt-3">
                    <% folderContents.forEach(function(file){%>
                        <% fileType =  file.split('.')[1]%>
                            <% if(fileType === 'pdf'){%>
                                <a href="#" class="list-group-item list-group-item-action list-group-item-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-pdf" viewBox="0 0 16 16">
                                        <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
                                        <path d="M4.603 12.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.701 19.701 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.187-.012.395-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.065.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.716 5.716 0 0 1-.911-.95 11.642 11.642 0 0 0-1.997.406 11.311 11.311 0 0 1-1.021 1.51c-.29.35-.608.655-.926.787a.793.793 0 0 1-.58.029zm1.379-1.901c-.166.076-.32.156-.459.238-.328.194-.541.383-.647.547-.094.145-.096.25-.04.361.01.022.02.036.026.044a.27.27 0 0 0 .035-.012c.137-.056.355-.235.635-.572a8.18 8.18 0 0 0 .45-.606zm1.64-1.33a12.647 12.647 0 0 1 1.01-.193 11.666 11.666 0 0 1-.51-.858 20.741 20.741 0 0 1-.5 1.05zm2.446.45c.15.162.296.3.435.41.24.19.407.253.498.256a.107.107 0 0 0 .07-.015.307.307 0 0 0 .094-.125.436.436 0 0 0 .059-.2.095.095 0 0 0-.026-.063c-.052-.062-.2-.152-.518-.209a3.881 3.881 0 0 0-.612-.053zM8.078 5.8a6.7 6.7 0 0 0 .2-.828c.031-.188.043-.343.038-.465a.613.613 0 0 0-.032-.198.517.517 0 0 0-.145.04c-.087.035-.158.106-.196.283-.04.192-.03.469.046.822.024.111.054.227.09.346z"/>
                                      </svg>
                                    <%=file%>
                                </a>
                                <%}else if(fileType === 'png' || fileType === 'img'){%>
                                    <a href="#" class="list-group-item list-group-item-action list-group-item-success">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-image" viewBox="0 0 16 16">
                                            <path d="M8.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            <path d="M12 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM3 2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v8l-2.083-2.083a.5.5 0 0 0-.76.063L8 11 5.835 9.7a.5.5 0 0 0-.611.076L3 12V2z"/>
                                          </svg>
                                        <%=file%>
                                    </a>
                                    <%}else{%>
                                        <a href="#" class="list-group-item list-group-item-action list-group-item-success">
                                            <%=file%>
                                        </a>
                                        <%}%>
                                            <%})%>


                </div>
            </div>
        </div>

    </div>

    <%if(patient.diagnoses.length === 0){%>
        <input type="hidden" id="checkDiagnoses" name="checkDiagnoses" value="false">
        <%} else {%>
            <input type="hidden" id="checkDiagnoses" name="checkDiagnoses" value="true">
            <%}%>

                <% include ../partials/footer %>